---
title: "Draft Report"
author: "203 Section 6, Team 1"
output: pdf_document
---

### 1. An Introduction

**Research Question:** How is the COVID case rate related to the population density and distribution of demographics of a state? How does the effect of population make-up on case rate compare with the effect of policy decisions made in each state?"

For this report, the investigation will be centered around the effect of population metrics such as density and demographics and policy on the COVID case rates across the United States (US), which is grouped by the 50 states plus the District of Columbia (D.C.). This research question aims to measure the case rate per 100,000 residents within each state based on the make-up of the population, as well as the policy decisions that were or were not put into place in order to combat the rise of COVID cases. In this sense, the aim is to measure how dependent the COVID case rate is on that of which cannot be controlled (i.e., population and demographics) vs that of which can be controlled to a certain degree (i.e., implementation of policies to attempt to combat cases). With this information, one could suggest whether or not the proliferation of COVID can be controlled, and to the level at which these policies help with this control.

This question can be broken up into two distinctive areas of investigation. The first and primary area of investigation involves how the COVID case rate is affected by population metrics. For this, the key variables are COVID case rate per 100,000 residents and the population density per square mile. This will provide an initial understanding in the relationship between the spread of the virus and how densely populated a state is. Following this, the analysis considers variables that address the make-up of these populations, specifically focusing on the distribution of demographics such as race/ethnicity and age. In order to account for the varying population sizes across the states, the variables are operationalized by specifically looking at variables that contain a rate, in order to standardize across the samples. In this sense, the analysis quantifies the spread of COVID by leveraging the COVID case rate per 100,000 rate, and for population demographics it investigates the percentage distribution of the race/ethnicity and age categories (e.g., White % of Total Population).

The secondary area of investigation will be to also include variables that measure policy implementation within states, and to compare the effect of these as opposed to the primary area of investigation that is population metrics. Specifically, there is a focus on policies that address the mandates of wearing masks within the state. Through this, the aim is to analyze whether the implementation of mask related policies will have an effect on case rate, as well as the degree of this effect relative to population metrics. To operationalize these policies and simplifying the measurements, the models will only consider whether or not these policies were implemented through indicator variables (1 = implemented, 0 = not implemented).

Prior to the analysis, it is important to identify a set of assumptions that have been made throughout the report and to assess the appropriateness of the data. Although there may be other considerations against the appropriateness of the data, the following highlights three particular arguments that must be taken into account when interpreting the results of the analysis.

Firstly, it is important to note that given each state (with the addition of the District of Columbia) is treated as a unique data point, the sample contains 51 data points. Although this size meets the general rule of an adequate sample size, as the analysis begins to factor in the wide range of potential population distributions and demographics within the states, it is clear that there is large variation within the sample. For example, the population density can have large variability depending on the population concentration among a few large areas as well as the level of uninhabited or sparsely inhabited land within a state, while the demographics of population can depend on a wide range of factors such as geographic location and employment opportunities. It is also important to note that these data points cannot be considered independent of each other, as there is a lot of interstate travel and regional similarities in terms of population and policy. This indicates that the sample cannot be assumed to be IID. 

Secondly, note that there are many internal and external aspects of the selected variables that have not been included within the models. Just addressing the internal information that is lost, it can be seen that much of the information is not captured given the methods of operationalization. Among others, the loss of date-related information within policy implementation variables strips out any contextual knowledge regarding the length of policy implementation, and precludes the identification of how long a specific policy was implemented. Assuming that policy implementation has some effect on case rate, this difference in length of time could play a large part in the effect. There are also other external aspects that cannot be included, such as the level of population density broken out among different population demographics. 

Finally, with regard to the policy variables, this report focuses solely on mask mandates. Given this, it does not capture the effect of other policies that may or may not have a greater effect on the case rate (e.g., implementation of stay-at-home orders). This follows for the population-related variables, as they capture race/ethnicity and poverty, but not other characteristics such as proportions of residents with pre-existing conditions. In justification, these choices were largely made due to there either being an appropriate amount of samples in each category (e.g., most states have implemented basic policies such as the closure of non-essential businesses and the implementation of stay-at-home orders, and thus these were not included given the lack of samples for the states that have not implemented them), or that data on other policies or demographic measures were simply not readily available in the dataset.

### 2. A Model Building Process

  The primary variable of interest will be the total covid case rate per 100,000 residents. The covid case rate was judged to give a better understanding than the death rate because of the potential for other, unrecorded variables that could be correlated with a person dying from covid versus just becoming infected. For example, the availability and quality of medical care in a state may impact its ability to keep covid infected patients alive, although this is not represented in the data set. The health status of the residents in one state compared to another state may also affect the death rate, but this is also not included. Instead, the covid infection rate was chosen so that these other variables which may correlate with the death rate would not have to be considered. Finally, the covid infection rate was also chosen on a per capita basis so that potential total population differences between states would already be accounted for in the variable. 
  
  The modeling goal for the covid case rate will be one of description. A modelf of causation may be created out of this model if potential causal relationships are examined and incorporated into the model's structure. This may later be expanded to predict the covid case rate in the past seven days in order for a state to use it to potentially judge what effect a modeled policy may have on its current situation. 
  
  There are two broad groups of covariates which will be examined in building the model. The first is demographic information on the state, such as population density, the unemployment rate, or rate of people living in poverty. The second general group is that of policy decisions taken by the state, such as mask mandates, legal enforcements of policies, or the political party of the state's governor (which is assumed to be related to the policies they may support). Problematic covariates would include any of the other direct measures of covid severity in the state, such as total infection rate not on a per capita basis or death rates. It can be assumed that these variables would be colinear with the primary variable of interest since more covid cases per capita would imply more total cases not adjusted for population or be strongly correlated with more deaths per capita, etc. 

- **Common Data across models:**
```{r lib,include=FALSE}
library(lmtest)
library(sandwich)
library(tidyverse)
library(magrittr)
library(ggplot2)
library(patchwork)
```

```{r variables, warning=FALSE}
df <- read.csv("covid-19.csv", header = TRUE)
df<-df%>%
  rename(case_rate_100k = 'Case.Rate.per.100000',
         death_rate_100k = 'Death.Rate.per.100000',
         population_density = 'Population.density.per.square.miles',
         white_pct = 'White...of.Cases',
         black_pct = 'Black...of.Cases',
         hispanic_pct = 'Hispanic...of.Cases',
         other_pct = 'Other...of.Cases',
         state_emergency = 'State.of.emergency',
         business_closed = 'Closed.other.non.essential.businesses',
         business_reopen = 'Began.to.reopen.businesses.statewide',
         mask_public='Mandate.face.mask.use.by.all.individuals.in.public.spaces',
         mask_legal='No.legal.enforcement.of.face.mask.mandate') %>%
  select(case_rate_100k, death_rate_100k,population_density, white_pct, black_pct, hispanic_pct, 
         other_pct, state_emergency, business_closed, business_reopen, mask_public, mask_legal)
# Assign correct data types
cols.num <- c("white_pct","black_pct","hispanic_pct","other_pct")
df[cols.num] <- sapply(df[cols.num],as.numeric)
df$state_emergency=as.Date(df$state_emergency, format = "%m/%d/%Y")
df$business_closed=as.Date(df$business_closed, format = "%m/%d/%Y")
df$business_reopen=as.Date(df$business_reopen, format = "%m/%d/%Y")
head(df)
```
  
- **Regression Models:**
    - **Model 1** Does this model only include key explanatory variables?  Do the variables make sense given the measurement goals?  Did the team apply reasonable transformations to these variables, to capture the nature of the relationships?
    - **Model 2** Does this model represent a balanced approach, including variables that advance modeling goals without causing major issues?  Does the model succeed in reducing standard errors of the key variables compared to the base model?  Does it capture major non-linearities in the joint distribution of the variables?
    - **Model 3**  Does this model represent a maximalist approach, erring on the side of including most variables?  Is it still a reasonable model?  Are there any variables that are outcomes, and should therefore still be excluded?  Is there too much multicolinearity, to the point that the key causal effects cannot be measured?

    - For Model 3. Policy related variables will be introduced for the analytics. Policy variable "Mandate face mask use by all individuals in public spaces" (renamed as mask_public) is selected as control variable to predict the case rate. Given it has been proved that mask is effective in preventing the transmission of disease, it is expected that the mask policy mandate in public would have an effect in reducing the case rate. 
    There are other variables related to mask such as "No legal enforcement of face mask mandate" and "Mandate face mask use by employees in public-facing businesses", we believe these variables have a lower impact than the policy that is enforced to public. Also, it is very likely that if a state enforce public mask policy, they will by default enforce mask policy for employees in public-facing business. As a result, we believe mask policy for all individuals in public space can be used to effectively represents the policy impact. 
    It is worth to note that, the mask_public is in date format, which has value of zero or a actual date when the policy is enforced. According to the documentation, zero represents "the absence of an order or directive", which can be interpreted as the policy is not enforced by the state explicitly. For a leaner regression, the date values in mask_public column are transformed as value 1, so that we can distinguish whether states has public mask policy or not. It is also noted that by transforming the variable, some important information will be lost because the actual date (early or late) to enforce the policy can also have an impact to the case rate. However, it is hard to measure the time effect as different states that enforced the public mask policy may have different threshold.

Firstly, "mask_public_bool" column is created from "mask_public", with 1 represents that the state has a pulbic mask policy, and 0 means there's no explicit public mask policy from the state.
```{r}

df <- df %>% 
  mutate(
    mask_public_bool = case_when(
      mask_public == 0 ~ 0, 
      !(mask_public == 0) ~ 1
      )
  )
head(df)
```

Histograms below that shows the distribution of states that has public mask policy or not. Both distributions exhibits certain degree of normality. 
```{r}
hist(df$case_rate_100k[df$mask_public_bool == 1], xlab='Case Rate', ylab='Count', main='Case Rate - Mask Mandate in Public')
hist(df$case_rate_100k[df$mask_public_bool == 0], xlab='Case Rate', ylab='Count', main='Case Rate  - No Mask Mandate in Public')
```


A plot that shows the relationship between different policies vs case rate.
```{r}
df %>% 
  ggplot(aes(x = mask_public_bool, y = case_rate_100k, color = case_rate_100k)) + 
  geom_point(aes(size=case_rate_100k)) + 
  labs(
    title = 'Case Rate vs Mask Public Mandate', 
    x = 'Mask Mandate in Public', 
    y = 'Case Rate', 
    color = 'Case Rate'
  )
```

Next, the linear model is created from model 2 with the mask policy variables added for the regression.

```{r}
model3 <- lm(case_rate_100k ~ log(population_density) +white_pct+ mask_public_bool, data = df)
coeftest(model3, vcov = vcovHC)
```

Evaluation of the business closed variable.
```{r}

df$close_period = as.integer( df$business_reopen-df$business_closed)
head(df)
hist(df$close_period, xlab='close period', ylab='Count', main='close length')
df %>% 
  ggplot(aes(x = close_period, y = case_rate_100k, color = close_period)) + 
  geom_point() + 
  labs(
    title = 'Case Rate vs Mask Public Mandate', 
    x = 'Mask Mandate in Public', 
    y = 'Case Rate', 
    color = 'Case Rate'
  )

model3 <- lm(case_rate_100k ~ close_period, data = df)
coeftest(model3, vcov = vcovHC)

df[is.na(df$business_closed),]
df[42,'business_closed'] = max(df$business_closed[!is.na(df$business_reopen)])
mean(df$business_closed)
df$business_close_diff = df$business_closed-mean(df$business_closed)
head(df)

df %>% 
  ggplot(aes(x = business_close_diff, y = case_rate_100k, color = close_period)) + 
  geom_point() + 
  labs(
    title = 'Case Rate vs Mask Public Mandate', 
    x = 'Mask Mandate in Public', 
    y = 'Case Rate', 
    color = 'Case Rate'
  )

model3 <- lm(case_rate_100k ~ business_close_diff + mask_public_bool, data = df)
coeftest(model3, vcov = vcovHC)

```

### 3. Limitations of the Model

The most general requirement for the linear model is that data points be independent and identically distributed (IID). While for the most part the events of one state will primarily affect that single state, travel by individuals spreading the virus across state lines is an inevitable occurence. This may cause the spread of a virus within one state to be influenced by those around it, or generally by its position in the country. While this is acknowledged to occur, the effect is likely minor compared to the demographic and policy data collected state by state which would affect the spread of the virus. Therefore it is relatively safe for this assumption to be met. 

Secondly, the process being modeled must be described by a linear conditional expectation function of the variables which are included, in order for the linear regression to be valid. This can be assessed after the fact by visualizing the model over the range of each variable alongside the data, or also by visualizing the residuals over the range of each variable. 

Related to the relationship of the residuals to the data, homoskedasticity can be assessed by visualizing the size of residuals across the range of each variable. Alternatively, it can also be done via the Breusch-Pagan test to more objectively determine whether homoskedasticity is not present in the data. 

Perfect colinearity is automatically detected by the R regression algorithms, which drop potential variables if they have complete colinearity with another variable. Near perfect colinearity is more problematic to detect, but a common hint to its existence is large standard errors on colinear features. Conceptually, the variables which may have an important colinearity in the final model are

Finally, normally distributed errors can be easily assessed by a histogram of the residuals around zero. Finally, normally distributed errors can be easily assessed by a histogram of the residuals around zero. 


