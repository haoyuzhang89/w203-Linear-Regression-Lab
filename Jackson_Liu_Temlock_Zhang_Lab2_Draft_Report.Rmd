---
title: "Lab 2 Final Report: COVID-19 Case Rate vs Population Demographics and Mask Policy"
author: "Aidan Jackson, Frank Liu, Sam Temlock, Haoyu Zhang"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

 **Initial reassignment of common data used across models:**
```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("GGally")
library(lmtest)
library(sandwich)
library(tidyverse)
library(magrittr)
library(ggplot2)
library(patchwork)
library(stargazer)
library(tinytex)
library(dplyr)
library(GGally)
library(car)
```

```{r variables, warning=FALSE, results='hide'}
df <- read.csv("covid-19.csv", header = TRUE)
df<-df%>%
  rename(case_rate_100k = 'Case.Rate.per.100000',
         population_density = 'Population.density.per.square.miles',
         mask_public='Mandate.face.mask.use.by.all.individuals.in.public.spaces',
         poverty_pct = "Percent.living.under.the.federal.poverty.line..2018.",
         unemployed_pct = "Percent.Unemployed..2018.",
         senior_pct = "X65.",
         population_2018 = "Population.2018" ## extra variable in test
         ) %>%
  select(State, case_rate_100k, population_density, mask_public, poverty_pct, 
         unemployed_pct, senior_pct, population_2018)
# Assign correct data types
head(df)
```

# 1. An Introduction

**Research Question:** How is the COVID-19 case rate related to the distribution of population demographics within a state, and how does the effect of these demographics compare with the effect of mask-related policy decisions made by that state?

For this report, the investigation will be centered around the effect of population demographics and policy on the COVID-19 case rates across the United States (US), which is grouped by the 50 states plus the District of Columbia (D.C.). Within the report, this collection will be referred to as the "states", and each member a "state", inclusive of D.C.. 

The research question aims to measure the COVID-19 case rate per 100,000 residents within each state based on the make-up of the population, as well as the policy decisions that were or were not put into place in order to combat the rise of COVID-19 cases. In this sense, the aim is to examine how dependent the COVID-19 case rate is on that of which cannot be controlled (i.e., population demographics), as well as that of which can be controlled to a certain degree (i.e., implementation of policies to attempt to combat case rate) by each state. With this information, one could suggest whether or not the proliferation of COVID-19 within a state seems to be related to either or both controllable and uncontrollable variables, and to the level at which the effect of these variables differ help. The modeling goal of this research question will be one of description, and will be broken up into three phases of investigation.

The first and primary phase of investigation involves how the COVID-19 case rate is affected by key population demographics. For this, the key variables are COVID-19 case rate per 100,000 residents and the percentage population distribution of seniors (defined as 65 years old or older) within a state. The case rate per 100,000 was selected as the key output/dependent variable as it provides a standardized measure of the spread of COVID-19 across the states, taking into account the absolute population of the states. The senior percentage was selected as the key input/independent variable given that guidance had been released by the Centers for Disease Control and Prevention (CDC) that seniors belong to the age category for those at higher risk of COVID-19, and thus are a well studied and documented group. This is likely due to the both the fact that seniors in this age group are more likely or had greater access to be tested given their categorization and the fact that they would have a greater likelihood of exhibiting detectable COVID-19 related symptoms that would prompt them to get tested. An additional rationale for measuring the senior percentage is that they may also be more likely to contract COVID-19 at lower viral loads, making them more susceptible to the virus. Conversely, this may result in seniors being more wary of the threat of COVID-19, and taking additional precautions to prevent infection relative to other age categories, such as limiting social interactions and taking more preventative measures in terms of hygiene. These key variables will provide an initial understanding of the relationship between the spread of the virus and population demographics. 

Following this, in the second phase of investigation the analysis considers other variables of state-level population that are considered factors of susceptibility, namely the rate of poverty (defined as the percent of individuals living under the federal poverty line in 2018) and the rate of unemployment (defined as the percent unemployment in 2018). Those living below the poverty line may have less access/are unable to afford to preventative controls such as sanitation products and masks that help prevent the spread of the virus, while those who are designated as unemployed may not have the flexibility of sheltering at home as well as access to the aforementioned preventative controls. Alternatively, the likelihood of reduced mobility for those living under the poverty line and/or who are unemployed may also play a role in the relationship with case rate. As mentioned, these variables operationalize population metrics that may lead to greater case rates, and are already standardized as rates to account for varying absolute populations across states.

The tertiary and final phase of investigation includes a variable that measures the implementation of policy as a response to COVID-19, and to understand the added effect of this variable in conjunction with the first phase of investigation that is state population metrics. Specifically, there is a focus on a policy that mandates the wearing of masks within the state. Through this, the aim is to analyze whether the implementation of a mask-related policy will have an effect on case rate, as well as the degree of this effect relative to population metrics. To operationalize this policy and simplify the measurements, the models only consider whether or not this policy was implemented through transformed indicator variables (1 = implemented, 0 = not implemented). As a result, factors of when and for how long the policy was implemented will be lost. Although this loss of information may fail to capture the impact of length of time of a policy on case rate (the policy may take time to be adopted/show meaningful efficacy), as there is no time-series data for case rate included in the data set, it was adjudged to be incongruent with the analysis.

Additionally, the final phase of investigation continues to expand on the examination of state-level population demographics via the population density variable (defined as the population density in square miles, population/square miles). A key factor to the spread of COVID-19 is the idea of social distancing, where the virus is considered to be more likely to spread when people are close in proximity. Thus, population density is measured as a conduit to indicate the level of proximity within each state and will operationalize the concept of social distancing.

## 1-1. Assumptions

Prior to the analysis, it is important to identify a set of assumptions that have been made throughout the report and to assess the appropriateness of the data. Although there may be other considerations against the appropriateness of the data, the following highlights three particular arguments that must be taken into account when interpreting the results of the analysis.

Firstly, it is important to note that given each state is treated as a unique data point, the sample contains 51 data points. Although this size meets the general rule that an adequate sample size is 30 data points or more, as the analysis begins to factor in the wide range of potential population distributions and demographics within the states, it is clear that there is large variation within the sample. For example, the population density can have large variability depending on the population concentration among a few large areas as well as the level of uninhabited or sparsely inhabited land within a state, while the demographics of population can depend on a wide range of things such as regional factors and employment opportunities. This point is further discussed in the IID assumption addressed in section 3 of this report.

Secondly, note that there are many internal and external aspects of the selected variables that have not been included within the models. Just addressing the internal information that is lost, it can be seen that some of the information is not captured given the methods of operationalization discussed previously. Among others, the loss of information on the date of implementation within the mask policy variable strips out any contextual knowledge regarding the length of policy implementation, and precludes the identification of how long a specific policy was implemented. Assuming that this has some effect on case rate, this difference in length of time may play a part in the effect. There are also other external aspects that cannot be included, such as the level of population density broken out among different population demographics. 

Finally, with regard to the policy variables, this report focuses on a form of mask mandate. Given this, it does not capture the effect of other policies that may or may not have a greater effect on the case rate (e.g., implementation of stay-at-home orders, closure of non-essential businesses, etc.). In justification, these choices were largely made due to there either being an appropriate amount of samples in each category (e.g., most states have implemented basic policies such as the closure of non-essential businesses and the implementation of stay-at-home orders, and thus these were not included given the lack of samples for the states that have not implemented them), or that data on other policies were simply not readily available in the dataset. The same argument can be applied in the selection of population demographics.

# 2. A Model Building Process

The primary variable of interest will be the total COVID-19 case rate per 100,000 residents. The COVID-19 case rate was judged to be able to provide a better understanding than the related death rate because of the potential for other, unrecorded variables that could be correlated with a person dying from COVID-19 versus just becoming infected. For example, the availability and quality of medical care in a state may impact its ability to keep COVID-19 infected patients alive, and these variables are not included in the data set. The health status of the residents in one state compared to another state may also affect the death rate, but this is also not included. Instead, the COVID-19 case rate was chosen so that these other variables which may correlate with the death rate would not have to be considered. 
  
The covariates that will be examined in building the models fit into two broad categories. The first category is demographic information on the state, namely percentage population distribution of seniors, the unemployment rate, the rate of people living in poverty, and the population density. The second general group is that of policy decisions taken by the state, specifically a mask mandate. Problematic covariates would include any of the other direct measures of COVID-19 severity in the state, namely total infection rate not on a per capita basis and COVID-19 death rates. It can be assumed that these variables would be collinear with the primary variable of interest since COVID-19 case rate is simply a linear transformation of total cases not adjusted for population, and death rate is derived from case rate.

As mentioned in the introduction, the modeling goal for the COVID-19 case rate will be one of description. A model of causation may follow this research if potential causal relationships are examined and incorporated into the model's structure. This may later be expanded to predict the COVID-19 case rate in the past seven days in order for a state to use it to potentially judge what effect a mask policy could have.

The three models aim to investigate the relationship between the COVID-19 case rate, state population demographics, and a mask mandates. COVID-19 case rate per 100,000 is chosen as the key dependent variable to represent the proliferation of the COVID-19 pandemic in each state. The population percentage of seniors is chosen as the key independent variable as a proxy for susceptibility by innate state population make-up. The variables of poverty percentage, unemployment percentage, mask mandate policy, and population density per square miles are chosen as candidate covariates to further explore the aforementioned potential relationship.

In order to allow for more simplistic and direct interpretations when analyzing the effect of the input variables on the output, it was determined that all percentage variables (senior, poverty, and unemployment) would be transformed into rates per 100,000 to align with the case rate variable. It will also serve to ease the burden on the readers of this report as like-for-like scaled relationships can be drawn between the variables. Given that this transformation is constant for all values (scalar multiplication of 100,000 for the seniors variable given it is a ratio, and 1,000 for poverty and unemployment given they are percentages on a scale of 0-100%), it will have no effect on the distributions of the variables.

```{r}  
# Percentage variables are re-scaled to rates per 100k
df <-df %>%
  mutate(    
    senior_per_100k = 100000*senior_pct,
    poverty_per_100k = 1000*poverty_pct, 
    unemployed_per_100k = 1000*unemployed_pct
  )
```

## 2-1. Model 1

### 2-1-1. Model 1 Exploratory Data Analysis

For the first model, the relationship between the COVID-19 case rate per 100,000 and the population percentage distribution of seniors was analyzed. 

First, the distribution of the case rate dependent variable is examined.

```{r, warning=FALSE, message=FALSE}
ggplot(data = df,
  mapping = aes(x= case_rate_100k)) +
  geom_histogram(fill = 'skyblue', color = 'grey30', breaks = seq(0,6000,600)) +
  labs(title =  "Histogram of COVID-19 Case Rate", 
       x = "COVID-19 case rate per 100,000", y = 'Count') +
  scale_x_continuous(breaks=seq(0, 6000, 600))
```

As can be seen above, the distribution is fairly normal, and given that it has already been standardized as a rate across all states, there is no need to perform any transformations on this variable. Thus, the case rate per 100,000 variable can be leveraged as is as the dependent variable for all three models.

Next, the distribution of the senior percentage transformed into the rate per 100,000 (as discussed in the Model Variables section) is examined.

```{r, warning=FALSE, message=FALSE}

ggplot(data = df,
  mapping = aes(x= senior_per_100k)) +
  geom_histogram(fill = 'skyblue', color = 'grey30', breaks = seq(10000,21000,1000)) +
  labs(title = 'Histogram of Seniors Distribution', 
  x = 'Number of seniors per 100,000', y = 'Count') + 
  scale_x_continuous(breaks=seq(10000,22000,1000))
```

As can be seen from the distribution above, again there is a fairly normal distribution in the population of seniors per 100,000 across the state. Additionally, there do not seem to be any outliers within the distribution, given that the range of rates fall between 11,000 and 21,000. Therefore, there are no transformations that need to be made in order to restructure the distribution, and this variable can be used across all three models.

With the appropriate variable distributions investigated, a plot is created to analyze the relationship between them. 

```{r message=FALSE}
df %>% 
  ggplot(aes(senior_per_100k, case_rate_100k)) + 
  geom_smooth(se = FALSE) +
  geom_point() +   
  labs(
    title = 'COVID-19 Case Rate due to Senior Population', 
    x = 'Number of seniors per 100,000', 
    y = 'COVID-19 case rate per 100,000'
  )
```

From the above plot, there is noticeable variation in the smoothed blue line. However, it can be posited that there is a inverse relationship between the variables given the roughly linear relationship in the overall downward trend in the line. 

### 2-1-2. Model 1 Regression

In order to test the relationship between the variables, the following equation is used to create a regression model to determine the true relationship between the case rate and population density variables. 

$$
case{\_}rate{\_}100k =\beta_0 + \beta_1 senior{\_}per{\_}100k
$$

```{r}
# Build the regression model for Model 1
model1 <- lm(case_rate_100k ~ senior_per_100k , data = df)
```

To improve the precision of the t-test of coefficients, classical standard errors can be used over robust standard errors to test the regression. To determine the applicability of using classical standard errors, in addition to the three Classical Linear Model (CLM) assumptions necessary for the robust standard errors, the CLM assumption for homoskedastic conditional errors should be evaluated. If this additional assumption is met, the robust standard errors can be replaced by the classical standard errors. The assumption of homoskedasticity is met if the data does not have large variance among the residuals. The analysis for this assumption, as well as the other CLM assumptions, is conducted in the following subsection titled "Model 1 CLM Assumptions".

Below, the t-test of coefficients is run on the regression model above. 

```{r}
coeftest(model1)
```

As can be seen from the above output, the variable for senior percentage is shown to be significant within the model specification with a p-value of 0.023. Furthermore, The coefficient of -0.174 for the variable is negative, supporting the earlier evaluation that there is an inverse relationship between the senior percentage and the case rate. In practical significance, this can be interpreted as for every additional senior per 100,000 in the population, there is a decrease of 0.174 COVID-19 cases per 100,000. More intuitively, for roughly every 6 additional seniors per 100,000, there is a decrease of 1 case per 100,000.

### 2-1-3. Model 1 Limitations

#### i. IID Sampling 

The first assumption of IID is not detailed within this section given that it is evaluated more generally for all three models within section 3. 

#### ii. Linear Conditional Expectation

The second CLM assumption to be evaluated is that of a linear conditional expectation relationship within the data, so that the model is accurately estimating the relationship between the variables. To test for this, the residuals of model 1 are plotted against its fitted values.

```{r}
# Check for linearty in model 1
plot(model1, which=1)
```

When examining the plot above for linearity in the conditional expectation, there is a noticeable slightly quadratic shape to the relationship of the conditional expectation. This may suggest that the relationship between the variables may not be as linear as the model assumes. However, as discussed previously in the scatter plot of the two variables, the relationship can be approximated as roughly linear. It is also difficult to explain the complexity behind the COVID-19 case rate with just a single variable that does not fully capture the broader population demographics. Additionally, there is hope that given the addition of other input variables within models 2 and 3, the relationship within the data will be better explained and result in more linearity. 

#### iii. No Perfect Collinearity

There is no test conducted for the third CLM assumption of no perfect collinearity in model 1 given there is only one input variable.

#### iv. Homoskedastic Errors

To evaluate the fourth CLM assumption of homoskedastic errors, the square root of the residuals (to remove any negative values) is plotted against the fitted values of the model. Additionally, a Breusch-Pagan test is run to check the level of heteroskedasticity.

```{r}
# Check the homoskedasticity of errors in model 1
plot(model1, which=3)

# Run the Breusch-Pagan test for model 1
bptest(model1)
```

From the above plot, the variance in residuals can be seen to be roughly constant given the relative flatness of the plotted red line, thus meeting the assumption of homoskedastic conditional errors. This is supported by the p-value of 0.497 from the Breusch-Pagan test, meaning it fails to reject the null hypothesis that the conditional errors are not heteroskedastic. With this additional assumption met, the regression model is run using a t-test with classical standard errors. 

#### v. Normally Distributed Errors

The final CLM assumption examined for model 1 is the assumption of normality of errors. This is a necessary assumption to ascertain that the errors used in the regression are drawn from a normal distribution, so that they can be accepted when used to calculate the significance levels. Both a Q-Q plot and histogram of the distribution of the residuals is plotted to observe the normality.

```{r, message = FALSE}
# Create a histogram of the distribution of the model 1 residuals
plot_one <- df %>%
  ggplot(aes(x = resid(model1))) +
  stat_bin() +
  geom_histogram(fill = 'skyblue', color = 'grey30', bins=30) +
  labs(title =  "Histogram of the Model 1 Residuals", 
       x = "Model 1 residuals", y = 'Count')

# Create a QQ plot for the model 1 residuals
plot_two <- df %>% 
  ggplot(aes(sample = resid(model1))) + 
  stat_qq() + stat_qq_line()

plot_one / plot_two
```

From the QQ plot, normality in the residuals can be detected given the proximity of the points to the normal line. Additionally, although the shape is a little harder to observe, the histogram of the residuals also gives a fairly normal distribution.

#### vi. Influence of Data Points

In addition to the CLM assumptions, the Cook's distance is also examined by a plot of the residuals vs the model 1 leverage to estimate the influence of the data points and identify any outliers in the values. From the plot below, no obvious outliers are detected.

```{r, message = FALSE}
# Investigate outliers using Cook's distance
plot(model1, which=5)
```

## 2-2. Model 2

### 2-2-1. Model 2 Exploratory Data Analysis

Based on the work of model 1, two extra state demographic features regarding poverty rate (percentage living under the federal poverty line in 2018) and unemployment rate (percentage of unemployed in 2018) would be included in the analysis of model 2. In addition, both newly-introduced percentage variables would be transformed into rates per 100,000 to align with the case rate variable.

First, the distribution of the poverty rate is examined as below.

```{r}
ggplot(data = df,
  mapping = aes(x= poverty_per_100k))+
  geom_histogram(fill = 'skyblue', color = 'grey30', breaks = seq(6000,21200,800)) +
  labs(title =  "Histogram of Poverty Rate", 
       x = "Number of living under poverty line per 100,000", y = 'Count')+
  scale_x_continuous(breaks=seq(6000, 21200, 1600))
```
As shown in the above distribution, there is a fairly normal distribution in the poverty number per 100,000 across the states. Additionally, there is no outlier observed within the distribution, given that the range of rates fall between 7,600 and 19,700. Therefore, there is no further transformation in need for this variable in the following analysis process for both model 2 and model 3.


Next, the distribution of the unemployment rate is examined as below. 

```{r}
ggplot(data = df,
  mapping = aes(x= unemployed_per_100k))+
  geom_histogram(fill = 'skyblue', color = 'grey30', breaks = seq(2000,8000,500)) +
  labs(title =  "Histogram of Unemployment Rate", 
       x = "Number of unemployed per 100,000", y = 'Count')+
  scale_x_continuous(breaks=seq(2000, 8000, 1000))
```
According to the histogram above, the distribution of unemployed number per 100,000 is fairly normal distribution. Overall, it is not highly skewed or heavily tailed. Therefore, there is no further transformation needed for this variable in the following analysis process for both model 2 and model 3.

### 2-2-2. Model 2 Regression


Compared to model 1, the relationship investigated here is about variables space with higher dimensions. It would be challenging to observe notable variation from variables distribution plots as below. 

```{r message=FALSE}
case_poverty <- df %>% 
  ggplot(aes(poverty_per_100k, case_rate_100k, color = senior_per_100k)) + 
  geom_point() + 
  geom_smooth(se=FALSE)+
  labs(
    title = ' Association between Covid-19 case rate and the poverty rate', 
    x = 'Number of living under poverty line per 100,000',
    y = 'Covid-19 case rate per 100,000', 
    color = 'Senior num per 100k'
  )

case_unemployed <- df %>% 
  ggplot(aes(unemployed_per_100k, case_rate_100k, color = senior_per_100k)) + 
  geom_point() + 
  geom_smooth(se=FALSE)+
  labs(
    title = 'Association between Covid-19 case rate and the unemployment rate', 
    x = 'Number of unemployed per 100,000', 
    y = 'Covid-19 case rate per 100,000',
    color = 'Senior num per 100k'
  )

case_poverty / case_unemployed
```
However, there is an overall increasing trend of COVID-19 case rate with increasing poverty rate, while there is an inverse relationship between the variables of the COVID-19 case rate and the unemployment rate. 

Based on the above data exploratory result, the following equation is used to create a regression model to determine the relationship between the case rate and demographic features including the seniors rate, the rate of poverty and the rate of unemployment. 

$$
\begin{aligned}
 Case.Rate.Per.100K =\beta_0 &+\beta_1Senior.Rate.Per.100K +\beta_2Poverty.Rate.Per.100K +\beta_3Unemployed.Per.100K
\end{aligned}
$$

```{r}
model2 <- lm(case_rate_100k ~ senior_per_100k + poverty_per_100k + unemployed_per_100k, data = df)
```

According to the assessment of homoskedasticity of model 2, which would be discussed in the following paragraph (Model 2 Limitations - iv.Homoskedastic Errors), it is plausible to apply the classical standard errors in the t-test of coefficients here. 

```{r}
coeftest(model2)
```

Based on the test results of the estimated coefficients in model 2, all three demographic features discussed here are significantly related to the COVID-19 case rate, especially for the poverty rate (p-value < 0.01).

The coefficient of the senior_per_100k is -0.230970 and statistically significant, which implies that for every one thousand additional seniors per 100,000, there is a decrease of 231 COVID-19 cases per 100,000, holding other demographic features as constant. As discussed in mode1 1 section, although seniors are susceptible group, less mobility and social interaction with cautious self protection may play an important role in this pandemic situation. 

In addition, the coefficient of the poverty_per_100k (0.231750) indicates that for every one thousand additional people living under poverty line per 100,000, there is a increase of 232 COVID-19 cases per 100,000, holding other demographic features as constant. People living under the poverty line have limited access to medical resources. Moreover, most of them could only afford to live in the communities with poor hygiene conditions. 

Finally, the coefficient of the unemployed_per_100k is statistically significant and negative (-0.486191), which implies that for every one thousand additional unemployed, there is a decrease of 486 COVID-19 case per 100,000, holding other demographic features as constant. Although the unemployment leads to less medical insurance coverage and impact on their income, the unemployed people may have more flexibility to obey stay-at-home orders. In addition, there is less exposure probability when there is no commuting or in-place working required for the unemployed. 

### 2-2-3. Model 2 Limitations

#### i. IID Sampling 

The first assumption of IID is not detailed within this section given that it is evaluated more generally for all three models within section 3. 

#### ii. Linear Conditional Expectation
To assess the linear conditional expectation assumption in higher-dimensional space, the plots of predicted versus residuals of the model 2 is investigated as follows.  

```{r, echo=FALSE, warning=FALSE, message=FALSE}
df<- df%>% 
  mutate(
    model2_preds = predict(model2), 
    model2_resids = resid(model2)
  ) 
df %>% 
  ggplot(aes(model2_preds, model2_resids)) + 
  geom_point() + 
  stat_smooth()
```

Overall, the residuals maintain around zero across the predicted range. There is no assumption violation phenomenon that can be observed here. 

#### iii. No Perfect Collinearity

Since there are multiple covariates included in this model compared to the model 1, there is more concern about the no perfect collinearity assumption here. First, the list of variable coefficients shows that no variables were dropped, which means there is no perfect collinearity detected by the R function. 

```{r}
model2$coefficients
```

In addition, all the variance inflation factors are less than 4 as follows, which doesn't indicate the existence of collinearity. 

```{r}
vif(model2)
```

#### iv. Homoskedastic Errors
To evaluate the homoskedastic errors assumption, the square root of the residuals is plotted against the fitted values of model 2 (scale-location plot). Although, the curve is not perfectly flat, there is no obvious variance of the errors either. For reference, the data points marked in the plot represent Florida (10), New York (33) and North Dakota (35).

```{r, echo=FALSE}
plot(model2, which=3)
```

Additionally, a Breusch-Pagan test is run to check the level of heteroskedasticity. The test result shows it fails to reject the null hypothesis, which means there is no evidence for heteroskedasticity. Overall, the assumption of homoskedastic errors is satisfied for model 2. 

```{r, echo=FALSE}
bptest(model2)
```

#### v. Normally Distributed Errors
To access the assumption of normality of error distribution, both the histogram and the Q-Q plot of the residuals is shown as follow.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
plot_one <- df %>% 
  ggplot(aes(x = model2_resids)) +
  geom_histogram(fill = 'skyblue', color = 'grey30', bins=30) +
  labs(title =  "Histogram of the Model 2 Residuals", 
       x = "Model 2 residuals", y = 'Count')
  
plot_two <- df %>% 
  ggplot(aes(sample = model2_resids)) + 
  stat_qq() + stat_qq_line()

plot_one / plot_two
```
Limited by the sample size, it is hard to observe a perfect normal distribution from the histogram. However, the Q-Q plot implies no deviation from normality. Overall, the normally distributed errors assumption is satisfied for model 2. 

#### vi. Influence of Data Points

Additionally, Cook's distance is used to estimate the influence of each single data point. 

```{r, echo =FALSE}
plot(model2, which = 5)
```

No obvious outliers could be detected here. For reference, the marked data points are Florida (10), Maine (20), and North Dakota (30).

## 2-3. Model 3

### 2-3-1. Model 3 Exploratory Data Analysis

For Model 3, policy related variables will be introduced for the analytics. Policy variable "Mandate face mask use by all individuals in public spaces" (renamed as mask_public) is selected as control variable to predict the case rate. Given it has been proved that mask is effective in preventing the transmission of disease, it is expected that the mask policy mandate in public would have an effect in reducing the case rate. 

There are other variables related to mask such as "No legal enforcement of face mask mandate" and "Mandate face mask use by employees in public-facing businesses", we believe these variables have a lower impact than the policy that is enforced to public. Also, it is very likely that if a state enforce public mask policy, they will by default enforce mask policy for employees in public-facing business. As a result, we believe mask policy for all individuals in public space can be used to effectively represents the policy impact. 
    
It is worth to note that, the mask_public is in date format, which has value of zero or a actual date when the policy is enforced. According to the documentation, zero represents "the absence of an order or directive", which can be interpreted as the policy is not enforced by the state explicitly. For linear regression, the date values in mask_public column are transformed as value 1, so that we can distinguish whether states has public mask policy or not. It is also noted that by transforming the variable, some important information will be lost because the actual date (early or late) to enforce the policy can also have an impact to the case rate. However, it is difficult to measure the time effect as different states that enforced the public mask policy may depend on related situations or different thresholds.

Firstly, "mask_public_bool" column is created from "mask_public", with 1 represents that the state has a pubic mask policy, and 0 means there's no explicit public mask policy from the state. The summary shows that there are 35 states that enforced public mask mandate, and 16 states that had no public mask policy. The ratio looks reasonable for the analysis considering sample size of 51 as there is decent number of samples for each state policy type. 

```{r}

df <- df %>% 
  mutate(
    mask_public_bool = case_when(
      mask_public == 0 ~ 0, 
      !(mask_public == 0) ~ 1
      )
  )

cat('Count for states that enforced mask mandate in public: ', 
    length(df$mask_public_bool[df$mask_public_bool==1]))

cat('\nCount for states did not enforced mask mandate in public: ', 
    length(df$mask_public_bool[df$mask_public_bool==0]))
```

Histograms below that shows the distribution of states that has public mask policy or not. Both distributions are not very normal with relatively small skews toward both tails. 

```{r, message = FALSE}

hist(df$case_rate_100k[df$mask_public_bool == 1], xlab='Case Rate', ylab='Count', 
     col='skyblue', main='Case Rate - States Enforced Mask Mandate in Public')
hist(df$case_rate_100k[df$mask_public_bool == 0], xlab='Case Rate', ylab='Count', 
     col='skyblue', main='Case Rate  - States Enformced No Mask Mandate in Public')
```

A plot that shows the relationship between different policies vs case rate.

```{r}
df %>% 
  ggplot(aes(x = mask_public_bool, y = case_rate_100k, color = case_rate_100k)) + 
  geom_point(aes(size=case_rate_100k)) + 
  labs(
    title = 'Case Rate vs Mask Public Mandate', 
    x = 'Mask Mandate in Public', 
    y = 'Case Rate', 
    color = 'Case Rate'
  )
```

Next, the distribution of the population density variable is examined.

```{r}
# Plot the distribution in a histogram
histogram_of_pdensity <- df %>%
  ggplot(aes(x = population_density)) + 
  geom_histogram(fill = 'skyblue', color = 'grey30', bins = 20) + 
  labs(
    title = 'Distribution of Population Density per Square Miles', 
    x = 'Population density per square mile', y = 'Count')

histogram_of_pdensity
```

As can be seen from the histogram, although most of the population density is concentrated in the 0 to 1500 range, there are some grouping of outliers that are very far from this concentration. When an analysis is performed, it can be seen that there is only one data sample that is the outlier, which is D.C. with a value of 11,496. This is given due to the fact that D.C. is a district that solely consists of a large city, as mentioned as a possibility in the introduction. Given that this causes the data to be skewed, the logarithm is taken to scale the variable. Alternatively, the data point could have been dropped from the sample, but given the already small sample size, it was determined that a better approach would be to keep it within the sample. Once this transformation was performed, it is shown that there is a relatively normal distribution of population densities (see figure below).

```{r}
# Find the outlier data points
outliers <- subset(df, population_density > 4000)
paste(outliers$State, '=', outliers$population_density)

# Transform the variable by taking the logarithm and assign it to a new variable
df <- df %>% 
  mutate(l_population_density = log10(population_density))

# Plot the new distribution in a histogram
histogram_of_pdensity <- df %>%
  ggplot(aes(x = l_population_density)) + 
  geom_histogram(fill = 'skyblue', color = 'grey30', bins = 20) + 
  labs(
    title = 'Distribution of Population Density per Square Miles', 
    x = 'Log of population density per square mile', y = 'Count')

histogram_of_pdensity
```

### 2-3-2. Model 3 Regression

Next, the regression model for model 3 is created based on the existing work from model 2. Two additional variables discussed in Model 3 will be introduced as maximalist approach. The first variable is the "mask_public_bool" (whether the state enforced public mask mandate or not) that represents the policy effects. The second variable introduced is "population_density" (the value is logged as discussed earlier) which is considered an important factor related to the spread of disease. 

The regression coefficient shows that Mask_public_bool variable is highly significant. And the result suggests that public mask mandate policy has positive effect in bringing the case number down. In detail, the COVID-19 case rate can be reduced by 945 out of every 100k people if the state enforces public mask mandate keeping all other variables the same. 

The population density variable however is not significant in the regression even it is considered as one of the major factors to the spread of disease. So according to the regression, we fail to reject the null hypothesis that population density have an direct impact to the COVID-19 case rate. There could be multiple factors causing the population density to be insignificant. For example, the population density is calculated by population divided by total square miles. As a result the numbers can be diluted for states that have major cities with high population density, but very little urbanization in the majority part of the state suburb area. In addition, as stated earlier in the research, Washington, D.C. is considered as a state however the demography structure and geographical related characteristics are different from other states. And due to a small sample we have, individual variables that exhibit unique characteristics could lead to certain degree of bias.

After careful discussion, the team still decided to keep "population_density" variable in model 3 even it is insignificant for the following reasons. First, adding population density variable has little effect on the change of coefficients of control variables in model 2. Second, we don't see evidence that the variable worsens the validation of CLM assumptions compared to model 2. Finally, the variable do offer meaningful information that is relevant to the main research question.

```{r, warning=FALSE}

model3 <- lm(case_rate_100k ~ senior_per_100k 
              + poverty_per_100k 
              + unemployed_per_100k 
             + mask_public_bool
             + log(population_density), data = df)
coeftest(model3)

```

### 2-3-3. Model 3 Limitations

#### i. I.I.D Assumption

The first assumption of IID is not detailed within this section given that it is evaluated more generally for all three models within section 3. 

#### ii. Linear Conditional Expectation


The Residual vs Fitted chat shows a almost flat line that is close to zero, with the tails a bit skewed. There is no strong evidence that there are unincoorperated linear relationship that we are not capturing from the control variables.
```{r}

plot(model3, which=1)
```

#### iii. No Perfect Collinearity

Based on the Variance Inflation Factors check, all the variables have variance-inflation factors less than 4. As a result, there's no strong evidence of collinearity concern within the model. 
```{r}

vif(model3)>4
```

#### iv. Homoskedastic Errors

According to the plot of Homoskedasticity, the standardized residual falls into a reasonable range and the line looks smooth without concerning skews. There is no significant evidence that the model violates homoskedasticity assumptions.
```{r}

plot(model3, which=3)

```

#### v. Normally Distributed Errors

To access the assumption of normality of error distribution, both the histogram and the Q-Q plot of the residuals is shown as follow.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
plot_one <- df %>% 
  ggplot(aes(x = resid(model3))) +
  geom_histogram(fill = 'skyblue', color = 'grey30', bins=30) +
  labs(title =  "Histogram of the Model 3 Residuals", 
       x = "Model 3 residuals", y = 'Count')
  
plot_two <- df %>% 
  ggplot(aes(sample = resid(model3))) + 
  stat_qq() + stat_qq_line()

plot_one / plot_two
```

There is a fairly normal distribution that can be seen from the histogram above. From the Q-Q plot, the points generally stay close to the normal line, with the tails exhibiting a certain degree of skew. However, in general, it implies no deviation from normality. Overall, the normally distributed errors assumption is satisfied for model 3. 

#### vi. Influence of Data Points

From the Cook's distance plot, there is no strong evidence of concerning outliers. For reference, the marked data points are D.C. (9), New Hampshire (30), and North Dakota (35).

```{r}

plot(model3, which=5)
```


# 3. Limitations of the Models

The most general requirement for all the linear models is that data points be independent and identically distributed (IID) which they are built off of. While for the most part the events of one state will primarily affect that single state, travel by individuals spreading the virus across state lines is an inevitable occurrence. This may cause the spread of a virus within one state to be influenced by those around it, or generally by its position in the country. In addition, all states are involved in the same market economy system of the country to varying degrees, even though there are economic performance divisions across the states. Likewise, certain regions of the country may also have similar demographics due to a shared history across general geographic regions. While this is acknowledged to occur, the effect is likely minor compared to the policy data collected state by state which would affect the spread of the virus. Therefore it is relatively safe for this assumption to be met. 

In examining the results of various diagnostics across different models, generally the CLM assumptions are better met as the model continues to develop. In the first model, deviations away from certain assumptions are the strongest. This is seen mostly with regards to the linear conditional expectation assumption, where the residuals against the fitted values have a noticeable inverted "V" shape as opposed to being constant around zero. In the second model, the same diagnostic shows that the assumption is better met. This is further improved upon in the third model, where local variations in the linear conditional expectation diagnostic plot are generally smoother and more centered around zero. The assumption with the greatest exception to this is that of no high colinearity within the models, as each coefficient in each model was shown to have VIF values not near the cut off value of four.

However, when adding more variables in the third model, other assumptions begin to be less well met. For example, the normality of the error term in the model is less well fit than it was in the earlier models. It can be seen in the third model's Q-Q plot how at fitted values towards the edges of the model's range, there exists the greatest deviation away from normality. This assumption is generally less important than that of the linear conditional expectation, however, which is a fundamental part of CLM. Therefore, the third model can still be considered as generally improving the overall analysis.

In addition, with more variables in the third model, outliers appear to have more of an impact than previously. This is likely due to the limited number of data points the model is based off of, an entire state only constitutes an individual datapoint. With less degrees of freedom in the third model, certain points can be seen to more closely approach the boundaries of the Cook's length plot, although they are still not extreme enough to fully be considered an outlier. Increasing the resolution of the data, such as examining COVID-19 cases at the county or city/town level, would help to reduce this by increasing the overall degrees of freedom.

# 4. Regression Table

With the analysis for the selected variables, the three corresponding models, and the respective diagnostics of the CLM assumptions complete, the models can then be included for comparison in a regression table. Model 1, model 2, and model 3 are included in the regression table below,.

```{r warning=FALSE}
se.model1 = coeftest(model1)[ , "Std. Error"]
se.model2 = coeftest(model2)[ , "Std. Error"]
se.model3 = coeftest(model3)[ , "Std. Error"]

stargazer(model1, model2, model3, type = "text",
          se = list(se.model3),
          star.cutoffs = c(0.05, 0.01, 0.001), 
          title = "Table 1: The effect of population demographics and mask policy on COVID-19 case rate")
```

Initially addressing the progression of the models at a macro level, the regression table highlights the fact that as the models build upon one another, they seem to get better at explaining the relationship between the input and output variables. Between model 1, 2, and 3, both the R2 and stricter adjusted R2 value increases as variables are added. The R2 value reflects the amount of variation that can be explained in the model on a 0-1 scale, while the adjusted R2 value does the same but also takes into account the number of variables measured (as can be seen in the decreasing degrees of freedom, df). The adjusted R2 value jumps from 0.082 initially in model 1 to a value of 0.267 in model 2, which is more than a 200% increase. The value again increases, albeit by a smaller amount, between model 2 and a value of 0.376 in model 3, which represents a 40% jump. When the R2 value is not adjusted, this value increases to 0.439 for model 3. Although not extraordinarily high given the scale, the value shows that that model 3 still explains much of the variance and is a relatively good predictor of the data, especially when compared to model 1. An additional value that reflects this improvement is the fact that the F-statistic is significant for all three models. The F-statistic is used to test whether or not to use the full model (inclusive of all input variables) or a reduced one with fewer variables. Given that the null hypothesis for this test is that the reduced model should be over the full model, this can be safely rejected in favor of the full model. Additionally, it can be seen that the standard errors for the significant variables are relatively small and are consistent across the models.

When diving into each model more closely and investigating the individual variable coefficients themselves, there is further evidence for robustness in the results across the models.

In model 1, the coefficient of -0.174 for the senior rate is significant with a p-value of 0.0234 (per the regression results from the Model 1 section). When the covariate variables of unemployment rate and poverty rate are added in to model 2, the coefficient for senior rate adjusts to a greater magnitude of -0.231 while the p-value appreciably decreases to a value of 0.0015 (per the regression results from the Model 2 section). This explains that not only has the magnitude of effect of the senior rate on case rate increased, but that this increased effect is also more statistically significant. In addition, the coefficients of the covariate variables themselves are also highly significant with p-values of 0.0005 and 0.0059 for poverty rate and unemployment rate respectively. The magnitude of the effect of poverty rate is almost equivalent to that of the senior rate, with a coefficient of 0.232, while the unemployment rate has stronger negative coefficient of -0.486 (roughly twice the magnitude of the other two variables).

Moving onto model 3, the magnitude of the coefficient for senior rate increases once again to a value of -0.242 while the statistical significance increases with a decreased p-value of 0.0004 (per the regression results from the Model 3 section). As highlighted before, the more complex model does a better job of predicting the effect of the senior rate variable. Conversely, the p-values for the poverty rate and unemployment rate coefficients become less significant, as they increase to 0.002 and 0.049 respectively. There are also detectable changes in the coefficient values, as the magnitude for both decreases to 0.197 and -0.364 respectively. The changes in the p-values are likely a direct result of the added variables of mask policy and the logarithmic transform of population density, where these variables introduce some additional variance in the model 2 covariates. Notably, the coefficient for the mask policy covariate is significant with a p-value of 0.0027 and has by far the greatest effect on the outcome variable with a coefficient of -945.6. The population density covariate is not significant with a p-value of 0.3369.

In terms of practical significance, there is great discrepancy between the effect of the mask policy variable compared to the other three significant features. With a coefficient of -945.6, this means that given the binary mask policy variable, when a mask policy is implemented (value of 1), there is an decrease in case rate of roughly 945 per 100,000 compared to when the policy is not in place. The next largest effect is from the unemployment rate variable, where in the final model, the coefficient of -0.364 translates to a decrease of roughly 1 case per 100,000 with every 3 additional people unemployed per 100,000. Similarly, the effects of both poverty rate and senior rate are nominal. For every 5 additional people per 100,000 who are below the poverty line, there is roughly 1 additional case per 100,000, and for every 4 additional seniors per 100,000 within the state population, there is roughly 1 fewer case per 100,000.

# 5. Omitted Variables

Omitted variables from the model may affect both the internal specifications of included variables as well as the general applicability of the model to explain the output variable. For this analysis, the omitted variables mentioned are hypothetical. Therefore, without data to include in an follow up analysis with the omitted variable, only the direction of the bias may be estimated rather than the size effect as well.

## 5-1. Urban vs Rural Population Ratio

One of the variables that was hypothesized as being potentially influential is a ratio of a state's urban to rural population. Currently, the dataset contains population information as averaged across each state as a whole. While population density is potentially useful, it was found to not be significant in the models. This may be due to states which have large urban centers, where population density would be high, losing their impact due to also containing large areas of land that is sparsely populated. One example of this would be New York, which contains several of the most densely populated counties in the country, but also large rural areas. 

An urban to rural ratio would be explanatory of the population density variable as a whole, where a higher urban to rural ratio would result in a higher statewide population density generally. With a greater fraction of urban residents, people would also be less likely to be able to social distance as effectively, increasing the per capita case rate. Therefore, the coefficient for population density in the original model would be larger and more positive than a model where this ratio is included, resulting in a bias that is positive and away from zero. Assuming population density as an effective proxy for an urban to rural ratio variable, however, the original effect described in the models can be assumed to be real. 

## 5-2. Median Income

Knowledge of the median income for a state would give an indication of the relative job status for a working person in that state. This would be important for the case rate to understand about how many people work in low paying jobs that are more frequently in close contact with others (such as the service industry, gig industry, etc.). Higher median income may imply that more workers are able to function remotely with greater social distancing. A higher median income would then be negatively related to the COVID case rate. It would also be explanatory in a way that makes the poverty percentage variable less impactful, where either of these variables may be considered as proxies for one another. Because inclusion of the median income variable would led to a lower magnitude poverty percentage variable, and that the coefficient of the poverty percentage variable is positive, this would cause a positive omitted variable bias away from zero. Similar to the first omitted variable, however, poverty percentage may also be assumed to proxy median income in that they both describe the economic state of a location and what that implies for its population. Because of this, the original effect in the model can be assumed to be real.

## 5-3. Gender Ratio

The ratio of gender between women and men may impact the COVID case rate in that men are more susceptible to viral infections and generally have lower life expectancy from lifestyle differences. Greater susceptibility may relate to the case rate in that men may more often become infected when exposed to COVID under similar circumstances as a women. Their shorter life expectancy may also impact the case rate in that more COVID cases may result in greater or more serious symptoms, with less occurrences of an infection that is asymptomatic or goes undetected. In either of these cases, a higher fraction of men among the population would lead to an overall higher COVID case rate. 

This variable could also be partially explained by the senior percentage variable, because of the increase of women in gender ratios generally as people get older. Therefore, introducing the gender ratio variable into the model would lower the value of the coefficient to the senior percentage variable to be less negative. This would be a negative omitted variable bias towards zero. With a negative bias, and no existing variable in the dataset that would serve as a good proxy for the gender ratio, the effects in the original model can be assumed to be real.

However, the magnitude of this change is likely to not be large due to other causal mechanisms between seniors and COVID case rate. While men may more frequently present COVID symptoms, older people in general are also more susceptible to the virus due to their physical condition and would also present more symptoms than non seniors. When comparing the two, generally seniors are considered as more at-risk of COVID complications than men across all ages, and so the senior percentage would still have a greater impact on the overall COVID case rate than the gender ratio. 

## 5-4. Mask Use Among Population

Currently, the model incorporates state policy around masks with a variable indicating whether or not a state mandated a mask policy for the general public. While this is useful for describing an action a state government can make and its affect on the case rate, it doesn't full capture whether how much the population actively wears a mask to drive down transmission. Instead, a variable which would indicate the fraction of the population actively wearing a mask would better capture the mechanism of how the virus is transmitted among people. 

A variable capturing the mask use among the population would likely reduce the explanatory power of the state mask mandate variable to be less negative. This would cause the bias of the omitted variable to be negative and towards from zero. It is also reasonable to assume that state mask policy may effectively enough proxy for the mask use among the population, in which case the original effect in the model may be assumed to be real.

## 5-5. GDP Percentage of Tourism

The economic standing of a state not only affects the individual households of its population, but also includes how it interacts with other states and how its peoples' lives might have been economically changed by the pandemic. One way that a state may increase its number of COVID cases is both from tourists or others visiting during the pandemic and bringing disease, but also if its own population must work in close contact with others serving them in the tourism industry. In addition, if certain key industries to a state, such as tourism, layed off many workers, they would likely have to take lower paying close contact jobs such as in the service or gig economy in order to continue having a livelihood. This would further lead to a higher COVID case rate 

These effects may be included with a variable that demonstrates how much of a state's GDP is from tourism. It would be related to other economic indicator variables, such as the percent of the population living in poverty. While poverty is a broader phenomena, the number of people in poverty in the pandemic could be potentially higher due to negative growth of the tourism industry. Therefore, it is expected that states with a greater focus on tourism may also have more people in poverty in the pandemic. This would take some of the explanatory power of the poverty variable away, resulting in its model coefficient becoming less positive. This would result in a positive omitted variable bias away from zero. Without a clear proxy in the dataset, and with the nature of this variable in touching on the IID assumption between interaction among states, it should be further investigated to understand how much of the original model may be an effect of omitted variable bias. 

# 6. Conclusion

The goal of the analysis was to address the research question to examine the relationship between both the distribution of population demographics and mask-related policy of a state and the COVID-19 case rate within that states. In order to address this question, the analysis was broken up into three phases of investigation with corresponding linear models:
- Phase 1: To investigate the direct relationship between COVID-19 case rate and the population distribution of seniors within a state
- Phase 2: To build upon Phase 1 by including two additional variables of population demographics, poverty rate and unemployment rate, and investigating the overall effect on COVID-19 case rate
- Phase 3: To build upon Phase 2 by adding a variable to measure the effect of the implementation of a mask-policy on COVID-19 case rate. A variable for population density was also added as an additional measure of population demographics

From the three phases of investigation, there was strong evidence in the data to suggest that senior rate, unemployment rate, and mask policy are all statistically significant in relation to case rate and have a negative relationship with case rate, while poverty rate has a positive relationship. The data for population density was not statistically significant enough to suggest a relationship. Out of the four significant variables, the greatest effect was from the mask policy variable, followed by the unemployment rate, and then similar absolute effect sizes from the senior rate and povery rate.

Starting with the variable with the greatest effect size, it can be seen that the implementation of a mask policy in a state leads to a decrease of 945 cases per 100,000. Given that research from leading health organizations shows that the wearing of masks helps to decrease the chance of the transmission of COVID-19, it could be suggested that a mask policy is effective in increasing the adoption of wearing masks among the state population. Next, it can be seen that there is a decrease of roughly 1 case per 100,000 with every 3 additional people unemployed per 100,000. This suggests that as unemployment increases, the case rate decreases, which could be a result of the fact that those who are unemployed may be less mobile as they are not commuting into work, lowering the likelihood of contracting the virus. Additionally, at the time that this data was collected, the Coronavirus Aid, Relief, and Economic Security (CARES) Act was still supporting the unemployed with relief payments so there was less urgency to be out looking for work. Following unemployment, when examining the poverty variable there is actually an increase of roughly 1 case per 100,000 for every 5 additional people per 100,000 living under the federal poverty line. Although there is some intuition behind the unemployment and poverty rates having similar effects on case rate, it can be seen from the test of collinearity in the Model 2 section that these two variables are not explaining the same effects. This difference is likely due to the fact that those living below the poverty line have less access to suitable living conditions and sanitary goods that help to alleviate the possibility of COVID-19 infection. As a caveat, it should be noted that these the poverty and unemployment figures are from a 2018 survey, so it does not reflect the full picture of the state demographics at the time of when the COVID-19 related data was captured. Finally, the effect of the senior rate is negative, with an additional 4 seniors per 100,000 translating to roughly 1 fewer case per 100,000. As touched upon in the introduction, this could be largely down to the fact that it is widely broadcasted that seniors fall within the high risk category in terms of having severe complications from COVID-19, and therefore they are more diligent in the precautions they take against contracting the virus.

In conclusion, we see that although the population demographics had varying effects on the COVID-19 case rate, the greatest effect was seen from the mask policy. Going back to our original question, it can be suggested within the data that the effect of a mask-related policy is something that should not be neglected in comparison to the population demographics. Therefore, it seems that the COVID-19 case rate at the state-level is dependent on masks, and that ultimately, there are effective policy and control measures that can be taken by state governments that have some contribution towards combating it's spread relative to factors that cannot be controlled. However, it should be noted that these insights are qualified by the assumptions and limitations laid out throughout the report, namely that there are potential issues in meeting the IID assumption and that there is explanatory information that is lost from both the variables investigated as well as the those that were not included in the dataset.

# References
